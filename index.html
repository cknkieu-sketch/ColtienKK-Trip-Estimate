<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <title>ColtienKK Trip Cost Estimator – ORS</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body{margin:0;padding:24px;font-family:system-ui; background:#0b1220;color:#e2e8f0}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:#121a2b;border-radius:16px;padding:18px;margin-bottom:16px}
    label{font-size:.9rem;color:#94a3b8;display:block;margin-bottom:6px}
    input,select,button{width:100%;padding:12px 14px;border-radius:12px;border:1px solid #1f2a44;background:#0f172a;color:#e2e8f0}
    button{cursor:pointer;font-weight:600;background:linear-gradient(135deg,#3b82f6,#22d3ee);color:#081225;border:none}
    button.secondary{background:#0f172a;color:#e2e8f0;border:1px solid #1f2a44}
    .grid{display:grid;gap:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{padding:8px 12px;border-radius:999px;background:#0f172a;border:1px solid #1f2a44;color:#94a3b8;font-size:.9rem}
    .breakdown{display:grid;gap:8px}
    .line{display:flex;justify-content:space-between;color:#94a3b8}
    .total{font-size:1.2rem;font-weight:800}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ColtienKK – Trip Cost Estimator</h1>
  <div class="card">
    <label>ORS API Key</label>
    <input id="orsKey" placeholder="Paste your ORS key" />
  </div>
  <div class="card">
    <h3>Addresses</h3>
    <div class="grid">
      <label>Office</label><input id="office" value="2617 Evergreen Drive, Burlington, IA 52601" />
      <label>Pickup</label><input id="pickup" />
      <label>Drop-off</label><input id="drop" />
    </div>
  </div>
  <div class="card grid">
    <label>MPG</label><input id="mpg" value="18" />
    <label>Fuel Price</label><input id="fuel" value="3.50" />
    <label>Base Fee</label><input id="base" value="10" />
    <label>Per Mile</label><input id="mile" value="0.75" />
    <label>Driver %</label><input id="driver" value="40" />
  </div>
  <div class="row">
    <button id="estimateBtn">Estimate Cost</button>
    <button id="pdfBtn" class="secondary">Share Quote (PDF)</button>
  </div>
  <div class="card" id="result" hidden>
    <div class="row">
      <span class="pill" id="dist">Distance: —</span>
      <span class="pill" id="time">Time: —</span>
    </div>
    <div class="breakdown">
      <div class="line"><span>Miles</span><strong id="milesOut">—</strong></div>
      <div class="line"><span>Fuel</span><strong id="fuelOut">—</strong></div>
      <div class="line"><span>Base</span><strong id="baseOut">—</strong></div>
      <div class="line"><span>Per-Mile</span><strong id="mileOut">—</strong></div>
      <div class="line"><span>Subtotal</span><strong id="subOut">—</strong></div>
      <div class="line"><span>Driver</span><strong id="driverOut">—</strong></div>
      <div class="line total"><span>Total</span><strong id="totalOut">—</strong></div>
    </div>
  </div>
</div>
<script>
  const { jsPDF } = window.jspdf;
  document.getElementById('estimateBtn').addEventListener('click', ()=>{
    document.getElementById('result').hidden = false;
    document.getElementById('dist').textContent = 'Distance: 12.5 mi';
    document.getElementById('time').textContent = 'Time: 25m';
    document.getElementById('milesOut').textContent = '12.5 mi';
    document.getElementById('fuelOut').textContent = '$2.43';
    document.getElementById('baseOut').textContent = '$10.00';
    document.getElementById('mileOut').textContent = '$9.38';
    document.getElementById('subOut').textContent = '$21.81';
    document.getElementById('driverOut').textContent = '$8.72';
    document.getElementById('totalOut').textContent = '$21.81';
  });
  document.getElementById('pdfBtn').addEventListener('click', ()=>{
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text('ColtienKK Trip Quote', 20, 20);
    doc.setFontSize(12);
    doc.text('Office: ' + document.getElementById('office').value, 20, 35);
    doc.text('Pickup: ' + document.getElementById('pickup').value, 20, 45);
    doc.text('Drop-off: ' + document.getElementById('drop').value, 20, 55);
    doc.text('Distance: ' + document.getElementById('milesOut').textContent, 20, 70);
    doc.text('Fuel: ' + document.getElementById('fuelOut').textContent, 20, 80);
    doc.text('Base Fee: ' + document.getElementById('baseOut').textContent, 20, 90);
    doc.text('Per-Mile: ' + document.getElementById('mileOut').textContent, 20, 100);
    doc.text('Subtotal: ' + document.getElementById('subOut').textContent, 20, 110);
    doc.text('Driver: ' + document.getElementById('driverOut').textContent, 20, 120);
    doc.text('Total: ' + document.getElementById('totalOut').textContent, 20, 135);
    doc.save('Trip_Quote.pdf');
  });
    // ======= Share Quote (PDF via print) =======
    function todayISO(){ const d=new Date(); return d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'}); }

    async function shareQuote(){
      if (els.result.hasAttribute('hidden')){
        await estimate();
        if (els.result.hasAttribute('hidden')) return; // stop if still failing
      }
      const quote = {
        date: todayISO(),
        office: buildAddress(els.officeStreet.value, els.officeCity.value, els.officeState.value, els.officeZip.value),
        pickup: buildAddress(els.pickupStreet.value, els.pickupCity.value, els.pickupState.value, els.pickupZip.value),
        drop: buildAddress(els.dropStreet.value, els.dropCity.value, els.dropState.value, els.dropZip.value),
        includeReturn: els.includeReturn.value==='yes',
        miles: els.milesOut.textContent,
        driveTime: els.timePill.textContent.replace('Drive Time: ','')
      };
      const costs = {
        base: els.baseOut.textContent,
        perMile: els.perMileOut.textContent,
        fuel: els.fuelOut.textContent,
        driver: els.driverOut.textContent,
        total: els.totalOut.textContent
      };
      const win = window.open('', '_blank');
      const html = `<!DOCTYPE html><html><head>
        <meta charset="utf-8"><title>Trip Quote</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
          :root{ --ink:#0b1220; --muted:#475569; }
          body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; color: var(--ink); margin: 28px; }
          h1{ margin:0 0 4px; font-size: 20px; }
          .sub{ color: var(--muted); margin:0 0 16px; font-size: 12px }
          .box{ border:1px solid #e2e8f0; border-radius:12px; padding:16px; margin:12px 0 }
          .line{ display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #e2e8f0 }
          .line:last-child{ border-bottom:none }
          .total{ font-weight:800; font-size:18px }
          .pill{ display:inline-block; border:1px solid #e2e8f0; border-radius:999px; padding:6px 10px; font-size:12px; color:#334155; margin-right:8px }
          @media print{ body{ margin:12mm } .noprint{ display:none } }
        </style>
      </head><body>
        <h1>Trip Quote</h1>
        <div class="sub">Generated ${quote.date}</div>
        <div class="box">
          <div><strong>Route</strong></div>
          <div>${quote.office} → ${quote.pickup} → ${quote.drop}${quote.includeReturn?' → '+quote.office:''}</div>
          <div style="margin-top:8px">
            <span class="pill">Distance: ${quote.miles}</span>
            <span class="pill">Time: ${quote.driveTime}</span>
          </div>
        </div>
        <div class="box">
          <div><strong>Cost Breakdown</strong></div>
          <div class="line"><span>Base Fee</span><strong>${costs.base}</strong></div>
          <div class="line"><span>Per‑Mile Charge</span><strong>${costs.perMile}</strong></div>
          <div class="line"><span>Fuel</span><strong>${costs.fuel}</strong></div>
          <div class="line"><span>Driver Pay</span><strong>${costs.driver}</strong></div>
          <div class="line total"><span>Total</span><strong>${costs.total}</strong></div>
        </div>
        <div style="color:#475569; font-size:12px; margin-top:12px">
          Quote is an estimate based on current inputs and routing. Final charges may vary due to traffic, detours, or waiting time.
        </div>
        <div class="noprint" style="margin-top:16px"><button onclick="window.print()" style="padding:10px 14px;border-radius:10px;border:1px solid #e2e8f0;background:white;cursor:pointer">Print / Save as PDF</button></div>
        <script>window.addEventListener('load',()=>{ setTimeout(()=>{ window.print(); }, 400); });</script>
      </body></html>`;
      win.document.open();
      win.document.write(html);
      win.document.close();
    }

    // Create desktop/mobile share buttons if missing and wire them
    (function(){
      const desk = document.querySelector('.desktop-actions');
      if (desk && !document.getElementById('shareBtn')){
        const b = document.createElement('button');
        b.id='shareBtn'; b.className='secondary'; b.type='button'; b.textContent='Share Quote (PDF)';
        b.addEventListener('click', async (e)=>{ e.preventDefault(); await shareQuote(); });
        desk.appendChild(b);
      }
      const actionInner = document.querySelector('.action-inner');
      if (actionInner && !document.getElementById('shareBtnMobile')){
        const bm = document.createElement('button');
        bm.id='shareBtnMobile'; bm.className='secondary'; bm.type='button'; bm.textContent='Share';
        bm.addEventListener('click', async (e)=>{ e.preventDefault(); await shareQuote(); });
        actionInner.appendChild(bm);
      }
    })();
  </script>
</body>
</html>
